{% extends "base.html" %}
{% block title %}Steps - FitFusion{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Steps Tracker - FitFusion</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <style>
    body {
      font-family: "Poppins", sans-serif;
    }
    #scheduleModal main {
      font-family: 'Inter', sans-serif;
    }
    #scheduleModal nav {
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    #scheduleModal nav button {
      scroll-snap-align: center;
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    .animate-fade-out {
      animation: fadeOut 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }
  </style>
</head>
<body class="bg-white min-h-screen p-4">
  <div class="max-w-md mx-auto">
    <!-- Header -->
    <header class="flex items-center justify-between mb-4">
      <a href="{{ url_for('home') }}" aria-label="Back" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 active:bg-gray-300">
        <svg aria-hidden="true" class="w-5 h-5 text-gray-900" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewbox="0 0 24 24">
          <path d="M15 18l-6-6 6-6"></path>
        </svg>
      </a>
      <h1 class="font-semibold text-lg text-gray-900">Steps Tracker</h1>
      <button aria-label="More options" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 active:bg-gray-300">
        <svg aria-hidden="true" class="w-5 h-5 text-gray-900" fill="currentColor" viewbox="0 0 20 20">
          <circle cx="6" cy="10" r="1.5"></circle>
          <circle cx="10" cy="10" r="1.5"></circle>
          <circle cx="14" cy="10" r="1.5"></circle>
        </svg>
      </button>
    </header>
    <div class="max-w-2xl mx-auto p-6 bg-white rounded-xl shadow-md border border-gray-100">
      <!-- Chart Header -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <div>
          <h2 class="text-xl font-bold text-gray-800">Steps Analytics</h2>
          <p class="text-sm text-gray-500">Track your weekly step count</p>
        </div>
        <div class="flex items-center gap-3">
          <!-- Today's Steps Button -->
          <button id="todayStepsBtn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-walking"></i> Today's Steps
          </button>
        </div>
      </div>
      <!-- Steps Input Modal (Hidden by default) -->
      <div id="stepsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Add Steps Data</h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input type="date" id="stepsDate" class="w-full p-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Steps</label>
              <div class="flex items-center space-x-2">
                <button id="decreaseSteps" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">-</button>
                <input type="number" id="stepsValue" step="1" min="0" max="100000" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., 10000">
                <button id="increaseSteps" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">+</button>
              </div>
            </div>
            <div class="pt-2">
              <button id="saveStepsBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                Save Steps Data
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Chart Container -->
      <div class="relative">
        <div class="flex justify-between items-center mb-3">
          <div class="text-sm font-medium text-gray-700">This Week</div>
          <div id="totalSteps" class="text-sm font-semibold text-indigo-600">Total: {{ user_data.steps_count }} steps</div>
        </div>
        <svg id="stepsChart" class="w-full h-52" viewBox="0 0 320 160" xmlns="http://www.w3.org/2000/svg">
          <rect width="100%" height="100%" fill="#f8fafc" rx="6" ry="6"></rect>
          <g id="horizontalGrid"></g>
          <g id="verticalGrid"></g>
          <defs>
            <linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1">
              <stop stop-color="#6366F1" stop-opacity="0.3"></stop>
              <stop offset="100%" stop-color="#6366F1" stop-opacity="0"></stop>
            </linearGradient>
          </defs>
          <path id="areaFill" fill="url(#gradient)" fill-opacity="0.4" stroke="#6366F1" stroke-width="2"></path>
          <path id="linePath" fill="none" stroke="#6366F1" stroke-width="2"></path>
          <g id="dataPoints"></g>
          <g id="yAxisLabels" font-family="Poppins" font-size="10" fill="#64748b"></g>
        </svg>
        <div class="flex justify-between mt-2 text-xs font-medium text-gray-500">
          <span>Sun</span>
          <span>Mon</span>
          <span>Tue</span>
          <span>Wed</span>
          <span>Thu</span>
          <span>Fri</span>
          <span>Sat</span>
        </div>
      </div>
    </div>
    <div class="h-8"></div>
    <!-- Steps Goal Button -->
    <div class="mb-6 flex justify-between items-center rounded-xl bg-indigo-100 px-5 py-3">
      <span class="font-semibold text-gray-900 text-sm">Steps Goal</span>
      <button id="openScheduleModal" class="bg-indigo-400 text-white text-xs font-semibold rounded-full px-4 py-1" type="button">
        Check
      </button>
    </div>
    <!-- Today Goal -->
    <h2 class="font-semibold text-gray-900 text-base mb-4">Today Goal</h2>
    <div class="space-y-4">
      <div class="flex items-center justify-between bg-white rounded-xl p-4 shadow-[0_2px_8px_rgba(0,0,0,0.05)]">
        <div class="flex items-center space-x-3">
          <img alt="Footsteps icon" class="w-10 h-10 flex-shrink-0" draggable="false" height="40" src="{{ url_for('static', filename='steps_icon.jpg') }}" width="40"/>
          <div>
            <p class="font-semibold text-gray-900 text-sm">
              Target Steps,
              <span class="font-normal text-gray-500">{{ user_data.steps_goal }} steps</span>
            </p>
            <p class="text-xs text-gray-500">Today: <span id="currentSteps">{{ user_data.steps_count }}</span> steps</p>
          </div>
        </div>
        <label class="relative inline-flex items-center cursor-pointer" for="toggle-steps">
          <input checked="" class="sr-only peer" id="toggle-steps" type="checkbox"/>
          <div class="w-11 h-6 bg-indigo-200 rounded-full peer peer-checked:bg-indigo-500 transition-colors"></div>
          <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full shadow transform peer-checked:translate-x-5 transition-transform"></div>
        </label>
      </div>
    </div>
    <!-- Steps Goal Modal -->
    <div id="scheduleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50">
      <div class="bg-[#FAFBFD] w-full h-full overflow-y-auto relative">
        <button id="closeScheduleModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-lg"></i>
        </button>
        <main class="w-full max-w-md mx-auto p-4">
          <header class="flex items-center justify-between mb-6">
            <a href="{{ url_for('home') }}" id="backScheduleModal" aria-label="Back" class="bg-[#F3F5F7] w-10 h-10 rounded-lg flex items-center justify-center">
              <i class="fas fa-chevron-left text-black text-lg"></i>
            </a>
            <h1 class="font-bold text-lg text-black">Steps Goal</h1>
            <button aria-label="More options" class="bg-[#F3F5F7] w-10 h-10 rounded-lg flex items-center justify-center">
              <i class="fas fa-ellipsis-h text-black text-lg"></i>
            </button>
          </header>
          <section aria-label="Ideal Steps Goal" class="bg-[#DDE9FF] rounded-3xl flex justify-between items-center p-6 mb-8">
            <div class="max-w-[60%]">
              <p class="text-black text-sm mb-1 font-normal">Ideal Daily Steps</p>
              <p class="text-[#8EA9E9] font-semibold text-lg mb-4">{{ user_data.steps_goal }} steps</p>
              <button class="bg-[#8EA9E9] text-white text-xs font-semibold rounded-full px-6 py-2 hover:bg-[#7a94d9] transition" type="button">
                Learn More
              </button>
            </div>
            <img alt="Footsteps illustration" class="w-24 h-24 object-contain" height="96" src="{{ url_for('static', filename='steps_icon.jpg') }}" width="96"/>
          </section>
          <h2 class="font-bold text-black text-lg mb-4">Your Goal</h2>
          <nav aria-label="Days of the week" class="flex space-x-3 overflow-x-auto pb-4 mb-6 snap-x">
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Wed</span>
              <span class="mt-1 font-semibold text-sm text-black">16</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Thu</span>
              <span class="mt-1 font-semibold text-sm text-black">17</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Fri</span>
              <span class="mt-1 font-semibold text-sm text-black">18</span>
            </button>
            <button aria-current="date" class="flex flex-col items-center justify-center bg-gradient-to-b from-[#8EA9E9] to-[#7A94D9] rounded-2xl w-16 h-20 shrink-0 text-white font-semibold text-sm" type="button">
              <span>Sat</span>
              <span class="mt-1 font-semibold text-lg">19</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Sun</span>
              <span class="mt-1 font-semibold text-sm text-black">20</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Mon</span>
              <span class="mt-1 font-semibold text-sm text-black">21</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Tue</span>
              <span class="mt-1 font-semibold text-sm text-black">22</span>
            </button>
          </nav>
          <section class="space-y-4 mb-8">
            <article aria-label="Steps goal" class="bg-white rounded-3xl flex items-center justify-between p-4 shadow-[0_10px_15px_-3px_rgba(142,169,233,0.3)]">
              <div class="flex items-center space-x-4">
                <img alt="Footsteps icon" class="w-8 h-8 flex-shrink-0" height="32" src="{{ url_for('static', filename='steps_icon.jpg') }}" width="32"/>
                <div>
                  <p class="font-bold text-black text-sm">
                    Target Steps,
                    <span class="font-normal text-xs text-[#9B9B9B]">{{ user_data.steps_goal }} steps</span>
                  </p>
                  <p class="text-[#9B9B9B] text-xs">
                    Today:
                    <span class="font-semibold text-sm text-black" id="modalCurrentSteps">{{ user_data.steps_count }} steps</span>
                  </p>
                </div>
              </div>
              <div class="flex items-center space-x-3">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input checked="" class="sr-only peer" type="checkbox"/>
                  <div class="w-11 h-6 bg-gradient-to-r from-[#B18CF7] to-[#A17CF6] rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-[#B18CF7] after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                </label>
                <button aria-label="More options" class="text-[#9B9B9B]">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
              </div>
            </article>
          </section>
          <section aria-label="Steps progress" class="bg-gradient-to-r from-[#E9D9F9] to-[#F3E9FD] rounded-3xl p-6 relative">
            <p class="text-black text-sm mb-4 max-w-[80%]">
              You need
              <span class="font-semibold" id="stepsDifference">{{ (user_data.steps_goal - user_data.steps_count) | int }} steps</span>
              to meet your daily goal
            </p>
            <div class="w-full h-4 rounded-full bg-[#D9B9F9] overflow-hidden">
              <div id="progressBar" class="h-4 rounded-full bg-gradient-to-r from-[#B18CF7] to-[#A17CF6] text-white text-xs font-semibold flex items-center justify-center" style="width: {{ (user_data.steps_count / user_data.steps_goal * 100) | round(1) }}%;">
                {{ (user_data.steps_count / user_data.steps_goal * 100) | round(1) }}%
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>
 
  <script>
    // Initialize steps data for each day (0=Sun, 1=Mon, ..., 6=Sat)
    let stepsData = Array(7).fill(0);
    const maxSteps = 20000; // Max steps for chart scaling
    const targetSteps = {{ user_data.steps_goal }};
    let currentSteps = {{ user_data.steps_count }};

    // DOM elements
    const stepsModal = document.getElementById('stepsModal');
    const todayStepsBtn = document.getElementById('todayStepsBtn');
    const closeModal = document.getElementById('closeModal');
    const saveStepsBtn = document.getElementById('saveStepsBtn');
    const stepsDate = document.getElementById('stepsDate');
    const stepsValue = document.getElementById('stepsValue');
    const totalStepsDisplay = document.getElementById('totalSteps');
    const scheduleModal = document.getElementById('scheduleModal');
    const open两国Modal = document.getElementById('openScheduleModal');
    const closeScheduleModal = document.getElementById('closeScheduleModal');
    const backScheduleModal = document.getElementById('backScheduleModal');
    const todayStepsInput = document.getElementById('todayStepsInput');
    const saveTodayStepsBtn = document.getElementById('saveTodayStepsBtn');
    const increaseSteps = document.getElementById('increaseSteps');
    const decreaseSteps = document.getElementById('decreaseSteps');
    const increaseTodaySteps = document.getElementById('increaseTodaySteps');
    const decreaseTodaySteps = document.getElementById('decreaseTodaySteps');
    const currentStepsDisplay = document.getElementById('currentSteps');
    const modalCurrentSteps = document.getElementById('modalCurrentSteps');
    const stepsDifference = document.getElementById('stepsDifference');
    const progressBar = document.getElementById('progressBar');

    // Set today's date as default
    function setCurrentDate() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      stepsDate.value = dateStr;
    }

    // Validate date is within current week
    function isDateInCurrentWeek(date) {
      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      return date >= weekStart && date <= weekEnd;
    }

    // Fetch steps data from server
    async function fetchStepsData() {
      try {
        const response = await fetch('/api/get_tracking');
        const data = await response.json();
        if (data.steps && data.steps.history) {
          const weekStart = new Date();
          weekStart.setDate(weekStart.getDate() - weekStart.getDay());
          stepsData = Array(7).fill(0);
          data.steps.history.forEach(entry => {
            const entryDate = new Date(entry.timestamp);
            const dayDiff = Math.floor((entryDate - weekStart) / (1000 * 60 * 60 * 24));
            if (dayDiff >= 0 && dayDiff < 7) {
              stepsData[dayDiff] = parseInt(entry.value);
              if (dayDiff === new Date().getDay()) {
                currentSteps = parseInt(entry.value);
              }
            }
          });
          updateChart();
          updateCurrentSteps();
          totalStepsDisplay.textContent = `Total: ${data.steps.value} steps`;
        }
      } catch (error) {
        console.error('Error fetching steps data:', error);
      }
    }

    // Initialize the chart
    function initChart() {
      drawGridLines();
      fetchStepsData();
      setCurrentDate();
      setupEventListeners();
    }

    // Draw grid lines
    function drawGridLines() {
      const horizontalGrid = document.getElementById('horizontalGrid');
      const verticalGrid = document.getElementById('verticalGrid');
      horizontalGrid.innerHTML = '';
      verticalGrid.innerHTML = '';
      
      // Horizontal grid lines
      for (let i = 0; i <= maxSteps; i += 5000) {
        const y = 160 - (i * (140 / maxSteps)) - 20;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('stroke', '#e2e8f0');
        line.setAttribute('stroke-width', '1');
        line.setAttribute('x1', '0');
        line.setAttribute('x2', '320');
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        horizontalGrid.appendChild(line);
      }
      
      // Vertical grid lines
      for (let i = 0; i < 7; i++) {
        const x = 45.7 + (i * 45.7);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('stroke', '#e2e8f0');
        line.setAttribute('stroke-width', '1');
        line.setAttribute('x1', x);
        line.setAttribute('x2', x);
        line.setAttribute('y1', '0');
        line.setAttribute('y2', '160');
        verticalGrid.appendChild(line);
      }
      
      // Y axis labels
      const yAxisLabels = document.getElementById('yAxisLabels');
      yAxisLabels.innerHTML = '';
      for (let i = 0; i <= maxSteps; i += 5000) {
        const y = 160 - (i * (140 / maxSteps)) - 20;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', '310');
        text.setAttribute('y', y + 4);
        text.setAttribute('text-anchor', 'end');
        text.textContent = `${i}`;
        yAxisLabels.appendChild(text);
      }
    }

    // Update chart with current data
    function updateChart() {
      const areaFill = document.getElementById('areaFill');
      const linePath = document.getElementById('linePath');
      const dataPoints = document.getElementById('dataPoints');
      dataPoints.innerHTML = '';
      
      let pathData = '';
      let areaData = '';
      let latestSteps = 0;

      for (let i = 0; i < 7; i++) {
        const x = 45.7 + (i * 45.7);
        const y = 160 - (stepsData[i] * (140 / maxSteps)) - 20;
        if (stepsData[i] > 0) {
          latestSteps = stepsData[i];
        }
        
        if (i === 0) {
          pathData = `M${x} ${y}`;
          areaData = `M${x} 160 L${x} ${y}`;
        } else {
          pathData += ` L${x} ${y}`;
          areaData += ` L${x} ${y}`;
        }
        
        // Add data point circles
        if (stepsData[i] > 0) {
          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('cx', x);
          circle.setAttribute('cy', y);
          circle.setAttribute('r', '4');
          circle.setAttribute('fill', 'white');
          circle.setAttribute('stroke', '#6366F1');
          circle.setAttribute('stroke-width', '2');
          circle.classList.add('cursor-pointer', 'hover:r-5', 'transition-all');
          circle.addEventListener('click', () => editDayData(i));
          dataPoints.appendChild(circle);
          
          // Add value label
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', x);
          text.setAttribute('y', y - 8);
          text.setAttribute('text-anchor', 'middle');
          text.setAttribute('font-size', '10');
          text.setAttribute('fill', '#6366F1');
          text.textContent = `${stepsData[i]}`;
          dataPoints.appendChild(text);
        }
      }
      
      areaData += ' L320 160 L0 160 Z';
      areaFill.setAttribute('d', areaData);
      linePath.setAttribute('d', pathData);
      totalStepsDisplay.textContent = `Total: ${latestSteps || currentSteps} steps`;
    }

    // Edit data for specific day
    function editDayData(dayIndex) {
      const date = new Date();
      date.setDate(date.getDate() - date.getDay() + dayIndex);
      stepsDate.value = date.toISOString().split('T')[0];
      stepsValue.value = stepsData[dayIndex] > 0 ? stepsData[dayIndex] : '';
      stepsModal.classList.remove('hidden');
    }

    // Update steps (increase/decrease) for modal
    async function updateSteps(action) {
      const currentValue = parseInt(stepsValue.value) || 0;
      let newValue = action === 'increase' ? currentValue + 100 : currentValue - 100;
      newValue = Math.max(0, Math.min(100000, newValue));
      stepsValue.value = newValue;
      try {
        const response = await fetch('/api/update_steps', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: action, value: newValue, timestamp: stepsDate.value })
        });
        if (response.ok) {
          const data = await response.json();
          currentSteps = parseInt(data.value);
          const date = new Date(stepsDate.value);
          const dayOfWeek = date.getDay();
          stepsData[dayOfWeek] = currentSteps;
          updateCurrentSteps();
          updateChart();
          showNotification(`Steps ${action === 'increase' ? 'increased' : 'decreased'} to ${currentSteps}`);
        } else {
          alert('Error updating steps');
        }
      } catch (error) {
        console.error('Error updating steps:', error);
        alert('Error updating steps');
      }
    }

    // Update steps (increase/decrease) for today input
    async function updateTodaySteps(action) {
      const currentValue = parseInt(todayStepsInput.value) || currentSteps;
      let newValue = action === 'increase' ? currentValue + 100 : currentValue - 100;
      newValue = Math.max(0, Math.min(100000, newValue));
      todayStepsInput.value = newValue;
      try {
        const response = await fetch('/api/update_steps', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: action, value: newValue, timestamp: new Date().toISOString() })
        });
        if (response.ok) {
          const data = await response.json();
          currentSteps = parseInt(data.value);
          const date = new Date();
          const dayOfWeek = date.getDay();
          stepsData[dayOfWeek] = currentSteps;
          updateCurrentSteps();
          updateChart();
          showNotification(`Steps ${action === 'increase' ? 'increased' : 'decreased'} to ${currentSteps}`);
        } else {
          alert('Error updating steps');
        }
      } catch (error) {
        console.error('Error updating steps:', error);
        alert('Error updating steps');
      }
    }

    // Save steps data to server
    async function saveStepsData() {
      const steps = parseInt(stepsValue.value);
      if (isNaN(steps) || steps < 0 || steps > 100000) {
        alert('Please enter a valid step count between 0 and 100,000');
        return;
      }
      const date = new Date(stepsDate.value);
      if (!stepsDate.value || !isDateInCurrentWeek(date)) {
        alert('Please select a date within the current week');
        return;
      }
      try {
        const response = await fetch('/api/update_steps', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ value: steps, timestamp: date.toISOString() })
        });
        if (response.ok) {
          const dayOfWeek = date.getDay();
          stepsData[dayOfWeek] = steps;
          if (dayOfWeek === new Date().getDay()) {
            currentSteps = steps;
            updateCurrentSteps();
          }
          updateChart();
          stepsModal.classList.add('hidden');
          showNotification('Steps data saved successfully!');
        } else {
          alert('Error saving steps data');
        }
      } catch (error) {
        console.error('Error saving steps:', error);
        alert('Error saving steps data');
      }
    }

    // Save today's steps to server
    async function saveTodaySteps() {
      const steps = parseInt(todayStepsInput.value);
      if (isNaN(steps) || steps < 0 || steps > 100000) {
        alert('Please enter a valid step count between 0 and 100,000');
        return;
      }
      const date = new Date();
      const dayOfWeek = date.getDay();
      try {
        const response = await fetch('/api/update_steps', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ value: steps, timestamp: date.toISOString() })
        });
        if (response.ok) {
          stepsData[dayOfWeek] = steps;
          currentSteps = steps;
          updateCurrentSteps();
          updateChart();
          todayStepsInput.value = '';
          showNotification('Today\'s steps saved successfully!');
        } else {
          alert('Error saving today\'s steps');
        }
      } catch (error) {
        console.error('Error saving today\'s steps:', error);
        alert('Error saving today\'s steps');
      }
    }

    // Update current steps displays and progress
    function updateCurrentSteps() {
      currentStepsDisplay.textContent = currentSteps;
      modalCurrentSteps.textContent = `${currentSteps} steps`;
      const difference = Math.max(0, targetSteps - currentSteps);
      stepsDifference.textContent = `${difference} steps`;
      const progress = Math.min((currentSteps / targetSteps * 100), 100).toFixed(1);
      progressBar.style.width = `${progress}%`;
      progressBar.textContent = `${progress}%`;
      totalStepsDisplay.textContent = `Total: ${currentSteps} steps`;
    }

    // Show notification
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg animate-fade-in';
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.classList.add('animate-fade-out');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Setup event listeners
    function setupEventListeners() {
      todayStepsBtn.addEventListener('click', () => {
        setCurrentDate();
        stepsValue.value = '';
        stepsModal.classList.remove('hidden');
      });
      closeModal.addEventListener('click', () => stepsModal.classList.add('hidden'));
      saveStepsBtn.addEventListener('click', saveStepsData);
      increaseSteps.addEventListener('click', () => updateSteps('increase'));
      decreaseSteps.addEventListener('click', () => updateSteps('decrease'));
      stepsModal.addEventListener('click', (e) => {
        if (e.target === stepsModal) {
          stepsModal.classList.add('hidden');
        }
      });
      openScheduleModal.addEventListener('click', () => {
        scheduleModal.classList.remove('hidden');
      });
      closeScheduleModal.addEventListener('click', () => {
        scheduleModal.classList.add('hidden');
      });
      backScheduleModal.addEventListener('click', () => {
        scheduleModal.classList.add('hidden');
      });
      scheduleModal.addEventListener('click', (e) => {
        if (e.target === scheduleModal) {
          scheduleModal.classList.add('hidden');
        }
      });
      saveTodayStepsBtn.addEventListener('click', saveTodaySteps);
      increaseTodaySteps.addEventListener('click', () => updateTodaySteps('increase'));
      decreaseTodaySteps.addEventListener('click', () => updateTodaySteps('decrease'));
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initChart);
  </script>
</body>
</html>
{% endblock %}