{% extends "base.html" %}
{% block title %}Water - FitFusion{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Water Tracker - FitFusion</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <style>
    body {
      font-family: "Poppins", sans-serif;
    }
    #scheduleModal main {
      font-family: 'Inter', sans-serif;
    }
    #scheduleModal nav {
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    #scheduleModal nav button {
      scroll-snap-align: center;
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    .animate-fade-out {
      animation: fadeOut 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }
  </style>
</head>
<body class="bg-white min-h-screen p-4">
  <div class="max-w-md mx-auto">
    <!-- Header -->
    <header class="flex items-center justify-between mb-4">
      <a href="{{ url_for('home') }}" aria-label="Back" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 active:bg-gray-300">
        <svg aria-hidden="true" class="w-5 h-5 text-gray-900" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewbox="0 0 24 24">
          <path d="M15 18l-6-6 6-6"></path>
        </svg>
      </a>
      <h1 class="font-semibold text-lg text-gray-900">Water Tracker</h1>
      <button aria-label="More options" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 active:bg-gray-300">
        <svg aria-hidden="true" class="w-5 h-5 text-gray-900" fill="currentColor" viewbox="0 0 20 20">
          <circle cx="6" cy="10" r="1.5"></circle>
          <circle cx="10" cy="10" r="1.5"></circle>
          <circle cx="14" cy="10" r="1.5"></circle>
        </svg>
      </button>
    </header>
    <div class="max-w-2xl mx-auto p-6 bg-white rounded-xl shadow-md border border-gray-100">
      <!-- Chart Header -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <div>
          <h2 class="text-xl font-bold text-gray-800">Water Intake Analytics</h2>
          <p class="text-sm text-gray-500">Track your weekly water intake</p>
        </div>
        <div class="flex items-center gap-3">
          <button id="todayWaterBtn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-tint"></i> Today's Water
          </button>
        </div>
      </div>
      <!-- Water Input Modal -->
      <div id="waterModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Add Water Intake</h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input type="date" id="waterDate" class="w-full p-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Water Intake (L)</label>
              <div class="flex items-center space-x-2">
                <button id="decreaseWater" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">-</button>
                <input type="number" id="waterValue" step="0.1" min="0" max="{{ user_data.water_goal }}" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., 2.0">
                <button id="increaseWater" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">+</button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Daily Goal (L)</label>
              <input type="number" id="waterMax" step="0.1" min="0.5" max="10" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., 2.5" value="{{ user_data.water_goal }}">
            </div>
            <div class="pt-2">
              <button id="saveWaterBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                Save Water Data
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Chart Container -->
      <div class="relative">
        <div class="flex justify-between items-center mb-3">
          <div class="text-sm font-medium text-gray-700">This Week</div>
          <div id="totalWater" class="text-sm font-semibold text-indigo-600">Current: {{ user_data.water_intake }} L</div>
        </div>
        <svg id="waterChart" class="w-full h-52" viewBox="0 0 320 160" xmlns="http://www.w3.org/2000/svg">
          <rect width="100%" height="100%" fill="#f8fafc" rx="6" ry="6"></rect>
          <g id="horizontalGrid"></g>
          <g id="verticalGrid"></g>
          <defs>
            <linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1">
              <stop stop-color="#6366F1" stop-opacity="0.3"></stop>
              <stop offset="100%" stop-color="#6366F1" stop-opacity="0"></stop>
            </linearGradient>
          </defs>
          <path id="areaFill" fill="url(#gradient)" fill-opacity="0.4" stroke="#6366F1" stroke-width="2"></path>
          <path id="linePath" fill="none" stroke="#6366F1" stroke-width="2"></path>
          <g id="dataPoints"></g>
          <g id="yAxisLabels" font-family="Poppins" font-size="10" fill="#64748b"></g>
        </svg>
        <div class="flex justify-between mt-2 text-xs font-medium text-gray-500">
          <span>Sun</span>
          <span>Mon</span>
          <span>Tue</span>
          <span>Wed</span>
          <span>Thu</span>
          <span>Fri</span>
          <span>Sat</span>
        </div>
      </div>
    </div>
    <div class="h-8"></div>
    <!-- Water Goal Button -->
    <div class="mb-6 flex justify-between items-center rounded-xl bg-indigo-100 px-5 py-3">
      <span class="font-semibold text-gray-900 text-sm">Water Goal</span>
      <button id="openScheduleModal" class="bg-indigo-400 text-white text-xs font-semibold rounded-full px-4 py-1" type="button">
        Check
      </button>
    </div>
    <!-- Today Goal -->
    <h2 class="font-semibold text-gray-900 text-base mb-4">Today Goal</h2>
    <div class="space-y-4">
      <div class="flex items-center justify-between bg-white rounded-xl p-4 shadow-[0_2px_8px_rgba(0,0,0,0.05)]">
        <div class="flex items-center space-x-3">
          <img alt="Water drop icon" class="w-10 h-10 flex-shrink-0" draggable="false" height="40" src="{{ url_for('static', filename='water_icon.jpg') }}" width="40"/>
          <div>
            <p class="font-semibold text-gray-900 text-sm">
              Target Water,
              <span class="font-normal text-gray-500">{{ user_data.water_goal }} L</span>
            </p>
            <p class="text-xs text-gray-500">Current: <span id="currentIntake">{{ user_data.water_intake }}</span> L</p>
          </div>
        </div>
        <label class="relative inline-flex items-center cursor-pointer" for="toggle-water">
          <input checked="" class="sr-only peer" id="toggle-water" type="checkbox"/>
          <div class="w-11 h-6 bg-indigo-200 rounded-full peer peer-checked:bg-indigo-500 transition-colors"></div>
          <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full shadow transform peer-checked:translate-x-5 transition-transform"></div>
        </label>
      </div>
    </div>
    <!-- Water Goal Modal -->
    <div id="scheduleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50">
      <div class="bg-[#FAFBFD] w-full h-full overflow-y-auto relative">
        <button id="closeScheduleModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-lg"></i>
        </button>
        <main class="w-full max-w-md mx-auto p-4">
          <header class="flex items-center justify-between mb-6">
            <a href="{{ url_for('home') }}" id="backScheduleModal" aria-label="Back" class="bg-[#F3F5F7] w-10 h-10 rounded-lg flex items-center justify-center">
              <i class="fas fa-chevron-left text-black text-lg"></i>
            </a>
            <h1 class="font-bold text-lg text-black">Water Goal</h1>
            <button aria-label="More options" class="bg-[#F3F5F7] w-10 h-10 rounded-lg flex items-center justify-center">
              <i class="fas fa-ellipsis-h text-black text-lg"></i>
            </button>
          </header>
          <section aria-label="Ideal Water Goal" class="bg-[#DDE9FF] rounded-3xl flex justify-between items-center p-6 mb-8">
            <div class="max-w-[60%]">
              <p class="text-black text-sm mb-1 font-normal">Ideal Daily Water Intake</p>
              <p class="text-[#8EA9E9] font-semibold text-lg mb-4">{{ user_data.water_goal }} L</p>
              <button class="bg-[#8EA9E9] text-white text-xs font-semibold rounded-full px-6 py-2 hover:bg-[#7a94d9] transition" type="button">
                Learn More
              </button>
            </div>
            <img alt="Water drop illustration" class="w-24 h-24 object-contain" height="96" src="{{ url_for('static', filename='water_icon.jpg') }}" width="96"/>
          </section>
          <h2 class="font-bold text-black text-lg mb-4">Your Goal</h2>
          <nav aria-label="Days of the week" class="flex space-x-3 overflow-x-auto pb-4 mb-6 snap-x">
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Sun</span>
              <span class="mt-1 font-semibold text-sm text-black">20</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Mon</span>
              <span class="mt-1 font-semibold text-sm text-black">21</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Tue</span>
              <span class="mt-1 font-semibold text-sm text-black">22</span>
            </button>
            <button aria-current="date" class="flex flex-col items-center justify-center bg-gradient-to-b from-[#8EA9E9] to-[#7A94D9] rounded-2xl w-16 h-20 shrink-0 text-white font-semibold text-sm" type="button">
              <span>Wed</span>
              <span class="mt-1 font-semibold text-lg">23</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Thu</span>
              <span class="mt-1 font-semibold text-sm text-black">24</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Fri</span>
              <span class="mt-1 font-semibold text-sm text-black">25</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Sat</span>
              <span class="mt-1 font-semibold text-sm text-black">26</span>
            </button>
          </nav>
          <section class="space-y-4 mb-8">
            <article aria-label="Water goal" class="bg-white rounded-3xl flex items-center justify-between p-4 shadow-[0_10px_15px_-3px_rgba(142,169,233,0.3)]">
              <div class="flex items-center space-x-4">
                <img alt="Water drop icon" class="w-8 h-8 flex-shrink-0" height="32" src="{{ url_for('static', filename='water_icon.jpg') }}" width="32"/>
                <div>
                  <p class="font-bold text-black text-sm">
                    Target Water,
                    <span class="font-normal text-xs text-[#9B9B9B]">{{ user_data.water_goal }} L</span>
                  </p>
                  <p class="text-[#9B9B9B] text-xs">
                    Current:
                    <span class="font-semibold text-sm text-black" id="modalCurrentIntake">{{ user_data.water_intake }} L</span>
                  </p>
                </div>
              </div>
              <div class="flex items-center space-x-3">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input checked="" class="sr-only peer" type="checkbox"/>
                  <div class="w-11 h-6 bg-gradient-to-r from-[#B18CF7] to-[#A17CF6] rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-[#B18CF7] after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                </label>
                <button aria-label="More options" class="text-[#9B9B9B]">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
              </div>
            </article>
          </section>
          <section aria-label="Water progress" class="bg-gradient-to-r from-[#E9D9F9] to-[#F3E9FD] rounded-3xl p-6 relative">
            <p class="text-black text-sm mb-4 max-w-[80%]">
              You are
              <span class="font-semibold" id="waterDifference">{{ (user_data.water_goal - user_data.water_intake) | round(1) }} L</span>
              from your daily goal
            </p>
            <div class="w-full h-4 rounded-full bg-[#D9B9F9] overflow-hidden">
              <div id="progressBar" class="h-4 rounded-full bg-gradient-to-r from-[#B18CF7] to-[#A17CF6] text-white text-xs font-semibold flex items-center justify-center" style="width: {{ (user_data.water_intake / user_data.water_goal * 100) | round(1) }}%;">
                {{ (user_data.water_intake / user_data.water_goal * 100) | round(1) }}%
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>
  <script>
    // Initialize water data for each day (0=Sun, 1=Mon, ..., 6=Sat)
    let waterData = Array(7).fill(0);
    const maxWater = 5; // Max water for chart scaling (L)
    let currentIntake = {{ user_data.water_intake }};
    let waterMax = {{ user_data.water_goal }};

    // DOM elements
    const waterModal = document.getElementById('waterModal');
    const todayWaterBtn = document.getElementById('todayWaterBtn');
    const closeModal = document.getElementById('closeModal');
    const saveWaterBtn = document.getElementById('saveWaterBtn');
    const waterDate = document.getElementById('waterDate');
    const waterValue = document.getElementById('waterValue');
    const waterMaxInput = document.getElementById('waterMax');
    const increaseWater = document.getElementById('increaseWater');
    const decreaseWater = document.getElementById('decreaseWater');
    const totalWaterDisplay = document.getElementById('totalWater');
    const scheduleModal = document.getElementById('scheduleModal');
    const openScheduleModal = document.getElementById('openScheduleModal');
    const closeScheduleModal = document.getElementById('closeScheduleModal');
    const backScheduleModal = document.getElementById('backScheduleModal');
    const progressBar = document.getElementById('progressBar');
    const todayWaterInput = document.getElementById('todayWaterInput');
    const saveTodayWaterBtn = document.getElementById('saveTodayWaterBtn');
    const increaseTodayWater = document.getElementById('increaseTodayWater');
    const decreaseTodayWater = document.getElementById('decreaseTodayWater');
    const currentIntakeDisplay = document.getElementById('currentIntake');
    const modalCurrentIntake = document.getElementById('modalCurrentIntake');
    const waterDifference = document.getElementById('waterDifference');

    // Set today's date as default
    function setCurrentDate() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      waterDate.value = dateStr;
    }

    // Validate date is within current week
    function isDateInCurrentWeek(date) {
      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      return date >= weekStart && date <= weekEnd;
    }

    // Fetch water data from server
    async function fetchWaterData() {
      try {
        const response = await fetch('/api/get_tracking');
        const data = await response.json();
        if (data.water) {
          currentIntake = parseFloat(data.water.intake);
          waterMax = parseFloat(data.water.max);
          waterValue.value = currentIntake.toFixed(1);
          waterMaxInput.value = waterMax.toFixed(1);
          totalWaterDisplay.textContent = `Current: ${currentIntake.toFixed(1)} L`;
          updateCurrentIntake();
          // Populate weekly data
          const weekStart = new Date();
          weekStart.setDate(weekStart.getDate() - weekStart.getDay());
          waterData = Array(7).fill(0);
          if (data.water.history) {
            data.water.history.forEach(entry => {
              const entryDate = new Date(entry.timestamp);
              const dayDiff = Math.floor((entryDate - weekStart) / (1000 * 60 * 60 * 24));
              if (dayDiff >= 0 && dayDiff < 7) {
                waterData[dayDiff] = parseFloat(entry.value);
                if (dayDiff === new Date().getDay()) {
                  currentIntake = parseFloat(entry.value);
                }
              }
            });
          }
          updateChart();
        }
      } catch (error) {
        console.error('Error fetching water data:', error);
      }
    }

    // Initialize the chart
    function initChart() {
      drawGridLines();
      fetchWaterData();
      setCurrentDate();
      setupEventListeners();
    }

    // Draw grid lines
    function drawGridLines() {
      const horizontalGrid = document.getElementById('horizontalGrid');
      const verticalGrid = document.getElementById('verticalGrid');
      horizontalGrid.innerHTML = '';
      verticalGrid.innerHTML = '';
      
      // Horizontal grid lines
      for (let i = 0; i <= maxWater; i += 1) {
        const y = 160 - (i * (140 / maxWater)) - 20;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('stroke', '#e2e8f0');
        line.setAttribute('stroke-width', '1');
        line.setAttribute('x1', '0');
        line.setAttribute('x2', '320');
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        horizontalGrid.appendChild(line);
      }
      
      // Vertical grid lines
      for (let i = 0; i < 7; i++) {
        const x = 45.7 + (i * 45.7);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('stroke', '#e2e8f0');
        line.setAttribute('stroke-width', '1');
        line.setAttribute('x1', x);
        line.setAttribute('x2', x);
        line.setAttribute('y1', '0');
        line.setAttribute('y2', '160');
        verticalGrid.appendChild(line);
      }
      
      // Y axis labels
      const yAxisLabels = document.getElementById('yAxisLabels');
      yAxisLabels.innerHTML = '';
      for (let i = 0; i <= maxWater; i += 1) {
        const y = 160 - (i * (140 / maxWater)) - 20;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', '310');
        text.setAttribute('y', y + 4);
        text.setAttribute('text-anchor', 'end');
        text.textContent = `${i} L`;
        yAxisLabels.appendChild(text);
      }
    }

    // Update chart with current data
    function updateChart() {
      const areaFill = document.getElementById('areaFill');
      const linePath = document.getElementById('linePath');
      const dataPoints = document.getElementById('dataPoints');
      dataPoints.innerHTML = '';
      
      let pathData = '';
      let areaData = '';
      let latestIntake = 0;

      for (let i = 0; i < 7; i++) {
        const x = 45.7 + (i * 45.7);
        const y = 160 - (waterData[i] * (140 / maxWater)) - 20;
        if (waterData[i] > 0) {
          latestIntake = waterData[i];
        }
        
        if (i === 0) {
          pathData = `M${x} ${y}`;
          areaData = `M${x} 160 L${x} ${y}`;
        } else {
          pathData += ` L${x} ${y}`;
          areaData += ` L${x} ${y}`;
        }
        
        // Add data point circles
        if (waterData[i] > 0) {
          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('cx', x);
          circle.setAttribute('cy', y);
          circle.setAttribute('r', '4');
          circle.setAttribute('fill', 'white');
          circle.setAttribute('stroke', '#6366F1');
          circle.setAttribute('stroke-width', '2');
          circle.classList.add('cursor-pointer', 'hover:r-5', 'transition-all');
          circle.addEventListener('click', () => editDayData(i));
          dataPoints.appendChild(circle);
          
          // Add value label
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', x);
          text.setAttribute('y', y - 8);
          text.setAttribute('text-anchor', 'middle');
          text.setAttribute('font-size', '10');
          text.setAttribute('fill', '#6366F1');
          text.textContent = `${waterData[i].toFixed(1)} L`;
          dataPoints.appendChild(text);
        }
      }
      
      areaData += ' L320 160 L0 160 Z';
      areaFill.setAttribute('d', areaData);
      linePath.setAttribute('d', pathData);
      totalWaterDisplay.textContent = `Current: ${latestIntake || currentIntake.toFixed(1)} L`;
    }

    // Edit data for specific day
    function editDayData(dayIndex) {
      const date = new Date();
      date.setDate(date.getDate() - date.getDay() + dayIndex);
      waterDate.value = date.toISOString().split('T')[0];
      waterValue.value = waterData[dayIndex] > 0 ? waterData[dayIndex].toFixed(1) : currentIntake.toFixed(1);
      waterMaxInput.value = waterMax.toFixed(1);
      waterModal.classList.remove('hidden');
    }

    // Update water intake (increase/decrease) for modal
    async function updateWaterIntake(action) {
      try {
        const response = await fetch('/api/update_water', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: action })
        });
        if (response.ok) {
          const data = await response.json();
          currentIntake = parseFloat(data.intake);
          waterMax = parseFloat(data.max);
          waterValue.value = currentIntake.toFixed(1);
          waterMaxInput.value = waterMax.toFixed(1);
          updateCurrentIntake();
          const date = new Date(waterDate.value);
          const dayOfWeek = date.getDay();
          waterData[dayOfWeek] = currentIntake;
          updateChart();
          showNotification(`Water intake ${action === 'increase' ? 'increased' : 'decreased'} to ${currentIntake.toFixed(1)} L`);
        } else {
          alert('Error updating water intake');
        }
      } catch (error) {
        console.error('Error updating water:', error);
        alert('Error updating water intake');
      }
    }

    // Update water intake (increase/decrease) for today input
    async function updateTodayWaterIntake(action) {
      try {
        const response = await fetch('/api/update_water', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: action })
        });
        if (response.ok) {
          const data = await response.json();
          currentIntake = parseFloat(data.intake);
          waterMax = parseFloat(data.max);
          todayWaterInput.value = currentIntake.toFixed(1);
          updateCurrentIntake();
          const date = new Date();
          const dayOfWeek = date.getDay();
          waterData[dayOfWeek] = currentIntake;
          updateChart();
          showNotification(`Water intake ${action === 'increase' ? 'increased' : 'decreased'} to ${currentIntake.toFixed(1)} L`);
        } else {
          alert('Error updating water intake');
        }
      } catch (error) {
        console.error('Error updating water:', error);
        alert('Error updating water intake');
      }
    }

    // Save water data (intake and max goal) from modal
    async function saveWaterData() {
      const intake = parseFloat(waterValue.value);
      const newMax = parseFloat(waterMaxInput.value);
      if (isNaN(intake) || intake < 0 || intake > 10) {
        alert('Please enter a valid water intake between 0 and 10 L');
        return;
      }
      if (isNaN(newMax) || newMax < 0.5 || newMax > 10) {
        alert('Please enter a valid daily goal between 0.5 and 10 L');
        return;
      }
      const date = new Date(waterDate.value);
      if (!waterDate.value || !isDateInCurrentWeek(date)) {
        alert('Please select a date within the current week');
        return;
      }
      try {
        const response = await fetch('/api/update_water', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'set_max', max: newMax })
        });
        if (response.ok) {
          const response2 = await fetch('/api/update_water', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'set', intake: intake, timestamp: date.toISOString() })
          });
          if (response2.ok) {
            currentIntake = intake;
            waterMax = newMax;
            const dayOfWeek = date.getDay();
            waterData[dayOfWeek] = intake;
            updateCurrentIntake();
            updateChart();
            waterModal.classList.add('hidden');
            showNotification('Water data saved successfully!');
          } else {
            alert('Error saving water intake');
          }
        } else {
          alert('Error saving water goal');
        }
      } catch (error) {
        console.error('Error saving water:', error);
        alert('Error saving water data');
      }
    }

    // Save today's water intake
    async function saveTodayWater() {
      const intake = parseFloat(todayWaterInput.value);
      if (isNaN(intake) || intake < 0 || intake > 10) {
        alert('Please enter a valid water intake between 0 and 10 L');
        return;
      }
      const date = new Date();
      const dayOfWeek = date.getDay();
      try {
        const response = await fetch('/api/update_water', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'set', intake: intake, timestamp: date.toISOString() })
        });
        if (response.ok) {
          currentIntake = intake;
          waterData[dayOfWeek] = intake;
          updateCurrentIntake();
          updateChart();
          todayWaterInput.value = '';
          showNotification('Today\'s water intake saved successfully!');
        } else {
          alert('Error saving today\'s water intake');
        }
      } catch (error) {
        console.error('Error saving today\'s water:', error);
        alert('Error saving today\'s water intake');
      }
    }

    // Update current intake displays and progress
    function updateCurrentIntake() {
      currentIntakeDisplay.textContent = currentIntake.toFixed(1);
      modalCurrentIntake.textContent = `${currentIntake.toFixed(1)} L`;
      const difference = (waterMax - currentIntake).toFixed(1);
      waterDifference.textContent = `${difference} L`;
      const progress = (currentIntake / waterMax * 100).toFixed(1);
      progressBar.style.width = `${progress}%`;
      progressBar.textContent = `${progress}%`;
      totalWaterDisplay.textContent = `Current: ${currentIntake.toFixed(1)} L`;
    }

    // Show notification
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg animate-fade-in';
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.classList.add('animate-fade-out');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Setup event listeners
    function setupEventListeners() {
      todayWaterBtn.addEventListener('click', () => {
        setCurrentDate();
        waterValue.value = currentIntake.toFixed(1);
        waterMaxInput.value = waterMax.toFixed(1);
        waterModal.classList.remove('hidden');
      });
      closeModal.addEventListener('click', () => waterModal.classList.add('hidden'));
      saveWaterBtn.addEventListener('click', saveWaterData);
      increaseWater.addEventListener('click', () => updateWaterIntake('increase'));
      decreaseWater.addEventListener('click', () => updateWaterIntake('decrease'));
      waterModal.addEventListener('click', (e) => {
        if (e.target === waterModal) {
          waterModal.classList.add('hidden');
        }
      });
      openScheduleModal.addEventListener('click', () => {
        scheduleModal.classList.remove('hidden');
      });
      closeScheduleModal.addEventListener('click', () => {
        scheduleModal.classList.add('hidden');
      });
      backScheduleModal.addEventListener('click', () => {
        scheduleModal.classList.add('hidden');
      });
      scheduleModal.addEventListener('click', (e) => {
        if (e.target === scheduleModal) {
          scheduleModal.classList.add('hidden');
        }
      });
      saveTodayWaterBtn.addEventListener('click', saveTodayWater);
      increaseTodayWater.addEventListener('click', () => updateTodayWaterIntake('increase'));
      decreaseTodayWater.addEventListener('click', () => updateTodayWaterIntake('decrease'));
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initChart);
  </script>
</body>
</html>
{% endblock %}