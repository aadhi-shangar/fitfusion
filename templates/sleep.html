{% extends "base.html" %}
{% block title %}Sleep Tracker - FitFusion{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
    }
    #scheduleModal main {
      font-family: 'Inter', sans-serif;
    }
    #scheduleModal nav {
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    #scheduleModal nav button {
      scroll-snap-align: center;
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    .animate-fade-out {
      animation: fadeOut 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }
  </style>
</head>
<body class="bg-white min-h-screen p-4">
  <div class="max-w-md mx-auto">
    <!-- Header -->
    <header class="flex items-center justify-between mb-4">
      <a href="{{ url_for('home') }}" aria-label="Back" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 active:bg-gray-300">
        <svg aria-hidden="true" class="w-5 h-5 text-gray-900" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24">
          <path d="M15 18l-6-6 6-6"></path>
        </svg>
      </a>
      <h1 class="font-semibold text-lg text-gray-900">Sleep Tracker</h1>
      <button aria-label="More options" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 active:bg-gray-300">
        <svg aria-hidden="true" class="w-5 h-5 text-gray-900" fill="currentColor" viewBox="0 0 20 20">
          <circle cx="6" cy="10" r="1.5"></circle>
          <circle cx="10" cy="10" r="1.5"></circle>
          <circle cx="14" cy="10" r="1.5"></circle>
        </svg>
      </button>
    </header>
    <div class="max-w-2xl mx-auto p-6 bg-white rounded-xl shadow-md border border-gray-100">
      <!-- Chart Header -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <div>
          <h2 class="text-xl font-bold text-gray-800">Sleep Duration Analytics</h2>
          <p class="text-sm text-gray-500">Track your weekly sleep duration</p>
        </div>
        <div class="flex items-center gap-3">
          <button id="todaySleepBtn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
            <i class="fas fa-moon"></i> Today's Sleep
          </button>
        </div>
      </div>
      <!-- Sleep Input Modal (Hidden by default) -->
      <div id="sleepModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Add Sleep Duration</h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input type="date" id="sleepDate" class="w-full p-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sleep Duration (hours)</label>
              <div class="flex items-center space-x-2">
                <button id="decreaseSleep" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">-</button>
                <input type="number" id="sleepValue" name="duration" step="0.1" min="0" max="12" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., 8.0">
                <button id="increaseSleep" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">+</button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Daily Goal (hours)</label>
              <input type="number" id="sleepGoal" step="0.1" min="4" max="12" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., 8.0" value="{{ user_data.sleep_goal }}">
            </div>
            <div class="pt-2">
              <button id="saveSleepBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                Save Sleep Data
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Chart Container -->
      <div class="relative">
        <div class="flex justify-between items-center mb-3">
          <div class="text-sm font-medium text-gray-700">This Week</div>
          <div id="totalSleep" class="text-sm font-semibold text-indigo-600">Current: {{ user_data.sleep_duration }} hr</div>
        </div>
        <svg id="sleepChart" class="w-full h-52" viewBox="0 0 320 160" xmlns="http://www.w3.org/2000/svg">
          <rect width="100%" height="100%" fill="#f8fafc" rx="6" ry="6"></rect>
          <g id="horizontalGrid"></g>
          <g id="verticalGrid"></g>
          <defs>
            <linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1">
              <stop stop-color="#6366F1" stop-opacity="0.3"></stop>
              <stop offset="100%" stop-color="#6366F1" stop-opacity="0"></stop>
            </linearGradient>
          </defs>
          <path id="areaFill" fill="url(#gradient)" fill-opacity="0.4" stroke="#6366F1" stroke-width="2"></path>
          <path id="linePath" fill="none" stroke="#6366F1" stroke-width="2"></path>
          <g id="dataPoints"></g>
          <g id="yAxisLabels" font-family="Poppins" font-size="10" fill="#64748b"></g>
        </svg>
        <div class="flex justify-between mt-2 text-xs font-medium text-gray-500">
          <span>Sun</span>
          <span>Mon</span>
          <span>Tue</span>
          <span>Wed</span>
          <span>Thu</span>
          <span>Fri</span>
          <span>Sat</span>
        </div>
      </div>
    </div>
    <div class="h-8"></div>
    <!-- Sleep Goal Button -->
    <div class="mb-6 flex justify-between items-center rounded-xl bg-indigo-100 px-5 py-3">
      <span class="font-semibold text-gray-900 text-sm">Sleep Goal</span>
      <button id="openScheduleModal" class="bg-indigo-400 text-white text-xs font-semibold rounded-full px-4 py-1" type="button">
        Check
      </button>
    </div>
    <!-- Today Goal -->
    <h2 class="font-semibold text-gray-900 text-base mb-4">Today Goal</h2>
    <div class="space-y-4">
      <div class="flex items-center justify-between bg-white rounded-xl p-4 shadow-[0_2px_8px_rgba(0,0,0,0.05)]">
        <div class="flex items-center space-x-3">
          <img alt="Moon icon" class="w-10 h-10 flex-shrink-0" draggable="false" height="40" src="{{ url_for('static', filename='sleep_icon.jpg') }}" width="40"/>
          <div>
            <p class="font-semibold text-gray-900 text-sm">
              Target Sleep,
              <span class="font-normal text-gray-500">{{ user_data.sleep_goal }} hr</span>
            </p>
            <p class="text-xs text-gray-500">Current: <span id="currentDuration">{{ user_data.sleep_duration }}</span> hr</p>
          </div>
        </div>
        <label class="relative inline-flex items-center cursor-pointer" for="toggle-sleep">
          <input checked="" class="sr-only peer" id="toggle-sleep" type="checkbox"/>
          <div class="w-11 h-6 bg-indigo-200 rounded-full peer peer-checked:bg-indigo-500 transition-colors"></div>
          <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full shadow transform peer-checked:translate-x-5 transition-transform"></div>
        </label>
      </div>
    </div>
    <!-- Sleep Goal Modal -->
    <div id="scheduleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50">
      <div class="bg-[#FAFBFD] w-full h-full overflow-y-auto relative">
        <button id="closeScheduleModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-lg"></i>
        </button>
        <main class="w-full max-w-md mx-auto p-4">
          <header class="flex items-center justify-between mb-6">
            <a href="{{ url_for('home') }}" id="backScheduleModal" aria-label="Back" class="bg-[#F3F5F7] w-10 h-10 rounded-lg flex items-center justify-center">
              <i class="fas fa-chevron-left text-black text-lg"></i>
            </a>
            <h1 class="font-bold text-lg text-black">Sleep Goal</h1>
            <button aria-label="More options" class="bg-[#F3F5F7] w-10 h-10 rounded-lg flex items-center justify-center">
              <i class="fas fa-ellipsis-h text-black text-lg"></i>
            </button>
          </header>
          <section aria-label="Ideal Sleep Goal" class="bg-[#DDE9FF] rounded-3xl flex justify-between items-center p-6 mb-8">
            <div class="max-w-[60%]">
              <p class="text-black text-sm mb-1 font-normal">Ideal Daily Sleep</p>
              <p class="text-[#8EA9E9] font-semibold text-lg mb-4">{{ user_data.sleep_goal }} hr</p>
              <button class="bg-[#8EA9E9] text-white text-xs font-semibold rounded-full px-6 py-2 hover:bg-[#7a94d9] transition" type="button">
                Learn More
              </button>
            </div>
            <img alt="Moon illustration" class="w-24 h-24 object-contain" height="96" src="{{ url_for('static', filename='sleep_icon.jpg') }}" width="96"/>
          </section>
          <h2 class="font-bold text-black text-lg mb-4">Your Goal</h2>
          <nav aria-label="Days of the week" class="flex space-x-3 overflow-x-auto pb-4 mb-6 snap-x">
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Wed</span>
              <span class="mt-1 font-semibold text-sm text-black">16</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Thu</span>
              <span class="mt-1 font-semibold text-sm text-black">17</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Fri</span>
              <span class="mt-1 font-semibold text-sm text-black">18</span>
            </button>
            <button aria-current="date" class="flex flex-col items-center justify-center bg-gradient-to-b from-[#8EA9E9] to-[#7A94D9] rounded-2xl w-16 h-20 shrink-0 text-white font-semibold text-sm" type="button">
              <span>Sat</span>
              <span class="mt-1 font-semibold text-lg">19</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Sun</span>
              <span class="mt-1 font-semibold text-sm text-black">20</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Mon</span>
              <span class="mt-1 font-semibold text-sm text-black">21</span>
            </button>
            <button class="flex flex-col items-center justify-center bg-[#F3F5F7] rounded-2xl w-16 h-20 shrink-0 text-[#9B9B9B] font-normal text-xs" type="button">
              <span>Tue</span>
              <span class="mt-1 font-semibold text-sm text-black">22</span>
            </button>
          </nav>
          <section class="space-y-4 mb-8">
            <article aria-label="Sleep goal" class="bg-white rounded-3xl flex items-center justify-between p-4 shadow-[0_10px_15px_-3px_rgba(142,169,233,0.3)]">
              <div class="flex items-center space-x-4">
                <img alt="Moon icon" class="w-8 h-8 flex-shrink-0" height="32" src="{{ url_for('static', filename='sleep_icon.jpg') }}" width="32"/>
                <div>
                  <p class="font-bold text-black text-sm">
                    Target Sleep,
                    <span class="font-normal text-xs text-[#9B9B9B]">{{ user_data.sleep_goal }} hr</span>
                  </p>
                  <p class="text-[#9B9B9B] text-xs">
                    Current:
                    <span class="font-semibold text-sm text-black" id="modalCurrentDuration">{{ user_data.sleep_duration }} hr</span>
                  </p>
                </div>
              </div>
              <div class="flex items-center space-x-3">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input checked="" class="sr-only peer" type="checkbox"/>
                  <div class="w-11 h-6 bg-gradient-to-r from-[#B18CF7] to-[#A17CF6] rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-[#B18CF7] after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                </label>
                <button aria-label="More options" class="text-[#9B9B9B]">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
              </div>
            </article>
          </section>
          <section aria-label="Sleep progress" class="bg-gradient-to-r from-[#E9D9F9] to-[#F3E9FD] rounded-3xl p-6 relative">
            <p class="text-black text-sm mb-4 max-w-[80%]">
              You are
              <span class="font-semibold" id="sleepDifference">{{ (user_data.sleep_goal - user_data.sleep_duration) | round(1) }} hr</span>
              from your daily goal
            </p>
            <div class="w-full h-4 rounded-full bg-[#D9B9F9] overflow-hidden">
              <div id="progressBar" class="h-4 rounded-full bg-gradient-to-r from-[#B18CF7] to-[#A17CF6] text-white text-xs font-semibold flex items-center justify-center" style="width: {{ (user_data.sleep_duration / user_data.sleep_goal * 100) | round(1) }}%;">
                {{ (user_data.sleep_duration / user_data.sleep_goal * 100) | round(1) }}%
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>
  <script>
    // Initialize sleep data for each day (0=Sun, 1=Mon, ..., 6=Sat)
    let sleepData = Array(7).fill(0);
    const maxSleep = 12; // Max sleep for chart scaling (hours)
    let currentDuration = {{ user_data.sleep_duration }};
    let sleepGoal = {{ user_data.sleep_goal }};

    // DOM elements
    const sleepModal = document.getElementById('sleepModal');
    const todaySleepBtn = document.getElementById('todaySleepBtn');
    const closeModal = document.getElementById('closeModal');
    const saveSleepBtn = document.getElementById('saveSleepBtn');
    const sleepDate = document.getElementById('sleepDate');
    const sleepValue = document.getElementById('sleepValue');
    const sleepGoalInput = document.getElementById('sleepGoal');
    const increaseSleep = document.getElementById('increaseSleep');
    const decreaseSleep = document.getElementById('decreaseSleep');
    const totalSleepDisplay = document.getElementById('totalSleep');
    const scheduleModal = document.getElementById('scheduleModal');
    const openScheduleModal = document.getElementById('openScheduleModal');
    const closeScheduleModal = document.getElementById('closeScheduleModal');
    const backScheduleModal = document.getElementById('backScheduleModal');
    const progressBar = document.getElementById('progressBar');
    const todaySleepInput = document.getElementById('todaySleepInput');
    const saveTodaySleepBtn = document.getElementById('saveTodaySleepBtn');
    const increaseTodaySleep = document.getElementById('increaseTodaySleep');
    const decreaseTodaySleep = document.getElementById('decreaseTodaySleep');
    const currentDurationDisplay = document.getElementById('currentDuration');
    const modalCurrentDuration = document.getElementById('modalCurrentDuration');
    const sleepDifference = document.getElementById('sleepDifference');

    // Set today's date as default
    function setCurrentDate() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      sleepDate.value = dateStr;
    }

    // Validate date is within current week
    function isDateInCurrentWeek(date) {
      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      return date >= weekStart && date <= weekEnd;
    }

    // Fetch sleep data from server
    async function fetchSleepData() {
      try {
        const response = await fetch('/api/get_tracking');
        const data = await response.json();
        if (data.sleep) {
          currentDuration = parseFloat(data.sleep.duration);
          sleepGoal = parseFloat(data.sleep.goal);
          sleepValue.value = currentDuration.toFixed(1);
          sleepGoalInput.value = sleepGoal.toFixed(1);
          totalSleepDisplay.textContent = `Current: ${currentDuration.toFixed(1)} hr`;
          updateCurrentDuration();
          // Populate weekly data
          const weekStart = new Date();
          weekStart.setDate(weekStart.getDate() - weekStart.getDay());
          sleepData = Array(7).fill(0);
          if (data.sleep.history) {
            data.sleep.history.forEach(entry => {
              const entryDate = new Date(entry.timestamp);
              const dayDiff = Math.floor((entryDate - weekStart) / (1000 * 60 * 60 * 24));
              if (dayDiff >= 0 && dayDiff < 7) {
                sleepData[dayDiff] = parseFloat(entry.value);
                if (dayDiff === new Date().getDay()) {
                  currentDuration = parseFloat(entry.value);
                }
              }
            });
          }
          updateChart();
        }
      } catch (error) {
        console.error('Error fetching sleep data:', error);
      }
    }

    // Initialize the chart
    function initChart() {
      drawGridLines();
      fetchSleepData();
      setCurrentDate();
      setupEventListeners();
    }

    // Draw grid lines
    function drawGridLines() {
      const horizontalGrid = document.getElementById('horizontalGrid');
      const verticalGrid = document.getElementById('verticalGrid');
      horizontalGrid.innerHTML = '';
      verticalGrid.innerHTML = '';
      
      // Horizontal grid lines
      for (let i = 0; i <= maxSleep; i += 2) {
        const y = 160 - (i * (140 / maxSleep)) - 20;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('stroke', '#e2e8f0');
        line.setAttribute('stroke-width', '1');
        line.setAttribute('x1', '0');
        line.setAttribute('x2', '320');
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        horizontalGrid.appendChild(line);
      }
      
      // Vertical grid lines
      for (let i = 0; i < 7; i++) {
        const x = 45.7 + (i * 45.7);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('stroke', '#e2e8f0');
        line.setAttribute('stroke-width', '1');
        line.setAttribute('x1', x);
        line.setAttribute('x2', x);
        line.setAttribute('y1', '0');
        line.setAttribute('y2', '160');
        verticalGrid.appendChild(line);
      }
      
      // Y axis labels
      const yAxisLabels = document.getElementById('yAxisLabels');
      yAxisLabels.innerHTML = '';
      for (let i = 0; i <= maxSleep; i += 2) {
        const y = 160 - (i * (140 / maxSleep)) - 20;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', '310');
        text.setAttribute('y', y + 4);
        text.setAttribute('text-anchor', 'end');
        text.textContent = `${i} hr`;
        yAxisLabels.appendChild(text);
      }
    }

    // Update chart with current data
    function updateChart() {
      const areaFill = document.getElementById('areaFill');
      const linePath = document.getElementById('linePath');
      const dataPoints = document.getElementById('dataPoints');
      dataPoints.innerHTML = '';
      
      let pathData = '';
      let areaData = '';
      let latestDuration = 0;

      for (let i = 0; i < 7; i++) {
        const x = 45.7 + (i * 45.7);
        const y = 160 - (sleepData[i] * (140 / maxSleep)) - 20;
        if (sleepData[i] > 0) {
          latestDuration = sleepData[i];
        }
        
        if (i === 0) {
          pathData = `M${x} ${y}`;
          areaData = `M${x} 160 L${x} ${y}`;
        } else {
          pathData += ` L${x} ${y}`;
          areaData += ` L${x} ${y}`;
        }
        
        // Add data point circles
        if (sleepData[i] > 0) {
          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('cx', x);
          circle.setAttribute('cy', y);
          circle.setAttribute('r', '4');
          circle.setAttribute('fill', 'white');
          circle.setAttribute('stroke', '#6366F1');
          circle.setAttribute('stroke-width', '2');
          circle.classList.add('cursor-pointer', 'hover:r-5', 'transition-all');
          circle.addEventListener('click', () => editDayData(i));
          dataPoints.appendChild(circle);
          
          // Add value label
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', x);
          text.setAttribute('y', y - 8);
          text.setAttribute('text-anchor', 'middle');
          text.setAttribute('font-size', '10');
          text.setAttribute('fill', '#6366F1');
          text.textContent = `${sleepData[i].toFixed(1)} hr`;
          dataPoints.appendChild(text);
        }
      }
      
      areaData += ' L320 160 L0 160 Z';
      areaFill.setAttribute('d', areaData);
      linePath.setAttribute('d', pathData);
      totalSleepDisplay.textContent = `Current: ${latestDuration || currentDuration.toFixed(1)} hr`;
    }

    // Edit data for specific day
    function editDayData(dayIndex) {
      const date = new Date();
      date.setDate(date.getDate() - date.getDay() + dayIndex);
      sleepDate.value = date.toISOString().split('T')[0];
      sleepValue.value = sleepData[dayIndex] > 0 ? sleepData[dayIndex].toFixed(1) : currentDuration.toFixed(1);
      sleepGoalInput.value = sleepGoal.toFixed(1);
      sleepModal.classList.remove('hidden');
    }

    // Update sleep duration (increase/decrease) for modal
    async function updateSleepDuration(action) {
      try {
        const response = await fetch('/api/update_sleep', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: action })
        });
        if (response.ok) {
          const data = await response.json();
          currentDuration = parseFloat(data.duration);
          sleepGoal = parseFloat(data.goal);
          sleepValue.value = currentDuration.toFixed(1);
          sleepGoalInput.value = sleepGoal.toFixed(1);
          updateCurrentDuration();
          const date = new Date(sleepDate.value);
          const dayOfWeek = date.getDay();
          sleepData[dayOfWeek] = currentDuration;
          updateChart();
          showNotification(`Sleep duration ${action === 'increase' ? 'increased' : 'decreased'} to ${currentDuration.toFixed(1)} hr`);
        } else {
          const errorData = await response.json();
          alert('Error updating sleep duration: ' + errorData.error);
        }
      } catch (error) {
        console.error('Error updating sleep:', error);
        alert('Error updating sleep duration');
      }
    }

    // Update sleep duration (increase/decrease) for today input
    async function updateTodaySleepDuration(action) {
      try {
        const response = await fetch('/api/update_sleep', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: action })
        });
        if (response.ok) {
          const data = await response.json();
          currentDuration = parseFloat(data.duration);
          sleepGoal = parseFloat(data.goal);
          todaySleepInput.value = currentDuration.toFixed(1);
          updateCurrentDuration();
          const date = new Date();
          const dayOfWeek = date.getDay();
          sleepData[dayOfWeek] = currentDuration;
          updateChart();
          showNotification(`Sleep duration ${action === 'increase' ? 'increased' : 'decreased'} to ${currentDuration.toFixed(1)} hr`);
        } else {
          const errorData = await response.json();
          alert('Error updating sleep duration: ' + errorData.error);
        }
      } catch (error) {
        console.error('Error updating sleep:', error);
        alert('Error updating sleep duration');
      }
    }

    // Save sleep data (duration and goal) from modal
    async function saveSleepData() {
      const duration = parseFloat(sleepValue.value);
      const newGoal = parseFloat(sleepGoalInput.value);
      if (isNaN(duration) || duration < 0 || duration > 12) {
        alert('Please enter a valid sleep duration between 0 and 12 hours');
        return;
      }
      if (isNaN(newGoal) || newGoal < 4 || newGoal > 12) {
        alert('Please enter a valid daily goal between 4 and 12 hours');
        return;
      }
      const date = new Date(sleepDate.value);
      if (!sleepDate.value || !isDateInCurrentWeek(date)) {
        alert('Please select a date within the current week');
        return;
      }
      try {
        const response = await fetch('/api/update_sleep', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'set_goal', goal: newGoal })
        });
        if (response.ok) {
          const response2 = await fetch('/api/update_sleep', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'set', duration: duration, timestamp: date.toISOString() })
          });
          if (response2.ok) {
            const data = await response2.json();
            currentDuration = duration;
            sleepGoal = newGoal;
            const dayOfWeek = date.getDay();
            sleepData[dayOfWeek] = duration;
            updateCurrentDuration();
            updateChart();
            sleepModal.classList.add('hidden');
            showNotification('Sleep data saved successfully!');
          } else {
            const errorData = await response2.json();
            alert('Error saving sleep duration: ' + errorData.error);
          }
        } else {
          const errorData = await response.json();
          alert('Error saving sleep goal: ' + errorData.error);
        }
      } catch (error) {
        console.error('Error saving sleep:', error);
        alert('Error saving sleep data');
      }
    }

    // Save today's sleep duration
    async function saveTodaySleep() {
      const duration = parseFloat(todaySleepInput.value);
      if (isNaN(duration) || duration < 0 || duration > 12) {
        alert('Please enter a valid sleep duration between 0 and 12 hours');
        return;
      }
      const date = new Date();
      try {
        const response = await fetch('/api/update_sleep', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'set', duration: duration, timestamp: date.toISOString() })
        });
        if (response.ok) {
          const data = await response.json();
          currentDuration = duration;
          sleepData[date.getDay()] = duration;
          updateCurrentDuration();
          updateChart();
          todaySleepInput.value = '';
          showNotification('Today\'s sleep duration saved successfully!');
        } else {
          const errorData = await response.json();
          alert('Error saving today\'s sleep duration: ' + errorData.error);
        }
      } catch (error) {
        console.error('Error saving today\'s sleep:', error);
        alert('Error saving today\'s sleep duration');
      }
    }

    // Update current duration displays and progress
    function updateCurrentDuration() {
      currentDurationDisplay.textContent = currentDuration.toFixed(1);
      modalCurrentDuration.textContent = `${currentDuration.toFixed(1)} hr`;
      const difference = (sleepGoal - currentDuration).toFixed(1);
      sleepDifference.textContent = `${difference} hr`;
      const progress = (currentDuration / sleepGoal * 100).toFixed(1);
      progressBar.style.width = `${progress}%`;
      progressBar.textContent = `${progress}%`;
      totalSleepDisplay.textContent = `Current: ${currentDuration.toFixed(1)} hr`;
    }

    // Show notification
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg animate-fade-in';
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.classList.add('animate-fade-out');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Setup event listeners
    function setupEventListeners() {
      todaySleepBtn.addEventListener('click', () => {
        setCurrentDate();
        sleepValue.value = currentDuration.toFixed(1);
        sleepGoalInput.value = sleepGoal.toFixed(1);
        sleepModal.classList.remove('hidden');
      });
      closeModal.addEventListener('click', () => sleepModal.classList.add('hidden'));
      saveSleepBtn.addEventListener('click', saveSleepData);
      increaseSleep.addEventListener('click', () => updateSleepDuration('increase'));
      decreaseSleep.addEventListener('click', () => updateSleepDuration('decrease'));
      sleepModal.addEventListener('click', (e) => {
        if (e.target === sleepModal) {
          sleepModal.classList.add('hidden');
        }
      });
      openScheduleModal.addEventListener('click', () => {
        scheduleModal.classList.remove('hidden');
      });
      closeScheduleModal.addEventListener('click', () => {
        scheduleModal.classList.add('hidden');
      });
      backScheduleModal.addEventListener('click', () => {
        scheduleModal.classList.add('hidden');
      });
      scheduleModal.addEventListener('click', (e) => {
        if (e.target === scheduleModal) {
          scheduleModal.classList.add('hidden');
        }
      });
      saveTodaySleepBtn.addEventListener('click', saveTodaySleep);
      increaseTodaySleep.addEventListener('click', () => updateTodaySleepDuration('increase'));
      decreaseTodaySleep.addEventListener('click', () => updateTodaySleepDuration('decrease'));
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initChart);
  </script>
</body>
</html>
{% endblock %}